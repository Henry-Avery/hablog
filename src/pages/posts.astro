---
import Layout from '@layouts/Layout.astro'
import PostsComponent from '@components/Posts.astro'
import MainGridLayout from '@components/layout/MainGridLayout.astro'
import { getSortedPosts } from '@utils/content-utils'

// Get query parameters
const url = Astro.url
const selectedTag = url.searchParams.get('tag')
const selectedCategory = url.searchParams.get('category')

// Get and filter posts
let posts = await getSortedPosts()

if (selectedTag) {
  posts = posts.filter(post =>
    post.data.tags?.includes(selectedTag)
  )
}

if (selectedCategory) {
  posts = posts.filter(post =>
    post.data.category === selectedCategory
  )
}

// Create page title
let title = 'Posts'
if (selectedTag) title = `Posts tagged "${selectedTag}"`
else if (selectedCategory) title = `Posts in "${selectedCategory}"`
---

<Layout title={`${title} - henryavery.cn`}>
  <section class="py-10">
    <div class="container mx-auto">
      <MainGridLayout showLeftSidebar={true}>
        <div class="space-y-10">
          <header class="space-y-3 text-center">
            <h2 class="text-5xl font-bold">{title}</h2>
            <p>
              {selectedTag && `Showing ${posts.length} posts tagged with "${selectedTag}"`}
              {selectedCategory && `Showing ${posts.length} posts in category "${selectedCategory}"`}
              {!selectedTag && !selectedCategory && 'Explore all posts'}
            </p>
            {(selectedTag || selectedCategory) && (
              <a href="/posts" class="btn btn-sm btn-ghost">
                Clear filter
              </a>
            )}
          </header>
          <PostsComponent posts={posts} maxPosts={100} />
        </div>
      </MainGridLayout>
    </div>
  </section>
</Layout>
