---
import Button from '@components/ui/Button.tsx'
import Search from '@components/Search.svelte'
import navbarSettings from '@settings/navbar.json';
import branding from '@settings/branding.json';

const buttons = navbarSettings?.buttons || []
const links = navbarSettings?.links || []

---
<div class="bg-base-100/50 sticky top-0 z-50 backdrop-blur-xl">
    <div class="navbar max-w-screen-2xl mx-auto">
      <div class="navbar-start">
        <div class="dropdown">
          <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h8m-8 6h16" />
            </svg>
          </div>
          <ul
            tabindex="0"
            class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-96 p-2 shadow">
            {links.map((link) => (
              <li>
                {link.isDropdown.discriminant ? (
                  <>
                    <a>{link.text}</a>
                    <ul class="p-2">
                      {link.isDropdown.value.map((sublink) => (
                          
                        <li>
                          <a href={sublink.link}>{sublink.text}</a>
                        </li>
                      ))}
                    </ul>
                    </details>
                  </>
                ) : (
                  <a href={link.isDropdown.value.link}>{link.text}</a>
                )}
              </li>
            ))}
            
        </div>
        <a href="/" aria-label={branding.site.siteName} class="btn btn-ghost text-xl">{branding.site.siteName}</a>
      </div>
      <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1 ">
          {links.map((link) => (
              <li>
                {link.isDropdown.discriminant ? (
                  <>
                    <details>
                      <summary>{link.text}</summary>
                    <ul class="p-2">
                      {link.isDropdown.value.map((sublink) => (
                          
                        <li>
                          <a href={sublink.link}>{sublink.text}</a>
                        </li>
                      ))}
                    </ul>
                    </details>
                  </>
                ) : (
                  <a href={link.isDropdown.value.link}>{link.text}</a>
                )}
              </li>
            ))}
      </div>
      <div class="navbar-end space-x-2">
          <Search client:load />
          {
              buttons.map((button) => {
                const allowedStyles = [
                  'primary',
                  'secondary',
                  'neutral',
                  'info',
                  'success',
                  'warning',
                  'error'
                ];
                const safeStyle = allowedStyles.includes(button.style)
                  ? button.style
                  : 'primary';
                return (
                  <Button
                    client:load
                    link={button.link}
                    label={button.label}
                    style={safeStyle as 'primary' | 'secondary' | 'neutral' | 'info' | 'success' | 'warning' | 'error'}
                    type={['ghost', 'link', 'outline', 'disabled', ''].includes(button.type) ? button.type as 'ghost' | 'link' | 'outline' | 'disabled' | '' : ''}
                    size={['', 'default', 'large', 'small', 'tiny', 'wide'].includes(button.size) ? button.size as '' | 'default' | 'large' | 'small' | 'tiny' | 'wide' : ''}
                    icon={button.icon}
                  />
                );
              })
            }
      </div>
    </div>
  </div>

<!-- Pagefind loader for production -->
{import.meta.env.PROD && (
  <script is:inline>
    async function loadPagefind() {
      try {
        const response = await fetch('/_pagefind/pagefind.js', { method: 'HEAD' });
        if (!response.ok) {
          throw new Error(`Pagefind script not found: ${response.status}`);
        }

        const pagefind = await import('/_pagefind/pagefind.js');

        await pagefind.options({
          excerptLength: 20
        });

        window.pagefind = pagefind;

        document.dispatchEvent(new CustomEvent('pagefindready'));
        console.log('Pagefind loaded and initialized successfully.');
      } catch (error) {
        console.error('Failed to load Pagefind:', error);
        window.pagefind = {
          search: () => Promise.resolve({ results: [] }),
          options: () => Promise.resolve(),
        };
        document.dispatchEvent(new CustomEvent('pagefindloaderror'));
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadPagefind);
    } else {
      loadPagefind();
    }
  </script>
)}