---
import { getCollection } from 'astro:content';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

const posts = await getCollection('posts');

// Get current month and year
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth();

// Create a map of post counts by date
const postCountByDate = new Map<string, number>();
posts.forEach(post => {
  const date = post.data.publishedDate;
  const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
  postCountByDate.set(dateKey, (postCountByDate.get(dateKey) || 0) + 1);
});
---

<div class:list={["card bg-base-200 p-4", className]} id="calendar-widget">
  <div class="text-center mb-4">
    <h3 class="text-lg font-bold">
      {new Date(currentYear, currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
    </h3>
  </div>

  <!-- Calendar grid will be generated by JavaScript -->
  <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
</div>

<script define:vars={{ currentYear, currentMonth, postCountByDate: Object.fromEntries(postCountByDate) }}>
  function generateCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    // Week days header
    const weekDays = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
    weekDays.forEach(day => {
      const header = document.createElement('div');
      header.className = 'text-center text-xs font-bold opacity-60 p-1';
      header.textContent = day;
      grid.appendChild(header);
    });

    // Empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement('div');
      grid.appendChild(empty);
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentYear}-${currentMonth + 1}-${day}`;
      const postCount = postCountByDate[dateKey] || 0;

      const dayCell = document.createElement('div');
      dayCell.className = `text-center p-2 rounded hover:bg-base-300 cursor-pointer transition-colors ${
        postCount > 0 ? 'bg-primary/20 font-bold' : ''
      }`;
      dayCell.textContent = day.toString();

      if (postCount > 0) {
        dayCell.title = `${postCount} post${postCount > 1 ? 's' : ''}`;
      }

      grid.appendChild(dayCell);
    }
  }

  // Generate calendar when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateCalendar);
  } else {
    generateCalendar();
  }
</script>
